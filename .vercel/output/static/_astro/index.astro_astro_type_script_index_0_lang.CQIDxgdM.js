import{supabaseBrowserClient as r}from"./supabase.D-cBqalA.js";import"./_commonjsHelpers.D6-XlEtG.js";import"./preload-helper.BlTxHScW.js";function u(){const e="test_storage_available";try{return localStorage.setItem(e,"test"),localStorage.removeItem(e),!0}catch{return!1}}function s(e){const t=document.getElementById("no-session-message");t&&(t.classList.remove("hidden"),t.classList.add("flex"),document.getElementById("current-url")?.setAttribute("textContent",window.location.href),document.getElementById("from-callback")?.setAttribute("textContent",String(e?.fromCallback||"No")),document.getElementById("user-agent")?.setAttribute("textContent",navigator.userAgent),document.getElementById("cookies-available")?.setAttribute("textContent",String(navigator.cookieEnabled)),document.getElementById("localstorage-available")?.setAttribute("textContent",String(u())));const o=document.getElementById("dashboard-content");o&&(o.style.opacity="0.2")}async function d(){try{console.log("Verificando sesión en el cliente...");const e=new URLSearchParams(window.location.search),t=e.get("auth")==="success"||e.get("auth")==="server_redirect"||e.get("auth")==="forced"||e.get("auth")==="callback_redirect",o=e.get("t");o&&console.log(`Timestamp de redirección del callback: ${o}`);const c=u();c||console.warn("localStorage no está disponible, esto afectará la autenticación");const{data:{user:l},error:n}=await r.auth.getUser();if(n)return console.error("Error al verificar usuario:",n),s({fromCallback:t,error:n.message}),!1;if(!l){if(console.log("No hay usuario autenticado en el cliente"),t){console.log("Venimos del callback pero no hay usuario, intentando recuperar la sesión...");const i=Object.keys(localStorage).some(a=>a.includes("supabase.auth"));console.log("Datos de autenticación en localStorage:",i);try{const{error:a}=await r.auth.refreshSession();if(a)console.error("Error al refrescar sesión:",a);else{const{data:g}=await r.auth.getUser();if(g?.user)return console.log("Sesión recuperada después del refresh"),!0}}catch(a){console.error("Error al intentar recuperar la sesión:",a)}console.log("No se pudo recuperar la sesión, mostrando error"),s({fromCallback:t,hasAuthData:i,storageAvailable:c,cookiesEnabled:navigator.cookieEnabled})}else window.location.href="/?auth=required";return!1}return console.log("Usuario autenticado verificado en el cliente:",l.email),!0}catch(e){return console.error("Error general al verificar autenticación:",e),s({error:e.message}),!1}}async function m(){try{await r.auth.signOut({scope:"global"}),Object.keys(localStorage).forEach(e=>{(e.includes("supabase")||e.includes("auth"))&&localStorage.removeItem(e)}),window.location.href="/"}catch(e){console.error("Error al cerrar sesión:",e)}}document.addEventListener("DOMContentLoaded",async()=>{console.log("Página del dashboard cargada, verificando sesión..."),await d(),document.getElementById("logout-btn")?.addEventListener("click",m),document.getElementById("retry-session-btn")?.addEventListener("click",async()=>{if(console.log("Intentando recuperar sesión..."),await d()){const t=document.getElementById("no-session-message");t&&(t.classList.add("hidden"),t.classList.remove("flex"));const o=document.getElementById("dashboard-content");o&&(o.style.opacity="1"),window.location.reload()}else setTimeout(()=>window.location.href="/?auth=failed",1e3)})});
