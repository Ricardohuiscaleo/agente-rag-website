import{supabaseBrowserClient as d}from"./supabase.CsEe2xpb.js";import"./_commonjsHelpers.D6-XlEtG.js";import"./preload-helper.BlTxHScW.js";function u(l){const a=document.getElementById("auth-error"),r=document.getElementById("error-message"),c=document.getElementById("loading-spinner");a&&r&&(r.textContent=l,a.style.display="block",c&&(c.style.display="none"))}function t(l,a){console.log(`[AUTH DEBUG] ${l}`,a!==void 0?a:"(no data)");const r=document.getElementById("debug-info");if(r){const c=new Date().toLocaleTimeString();let e="";a!=null&&(e=typeof a=="string"?a:JSON.stringify(a,null,2)),r.textContent+=`[${c}] ${l}
${e}

`}}const m=document.getElementById("debug-panel");(window.location.hostname==="localhost"||window.location.hostname==="127.0.0.1")&&m&&(m.style.display="block");document.addEventListener("DOMContentLoaded",()=>{if(t("Callback page script loaded",void 0),t("Current URL:",window.location.href),window.location.hash.includes("error=")){const e=window.location.hash.match(/error=([^&]+)/);if(e&&e[1]){const o=decodeURIComponent(e[1].replace(/\+/g," "));t("Error detected in URL hash:",o),u(`Error de autenticación: ${o}`)}}const{data:{subscription:l}}=d.auth.onAuthStateChange(async(e,o)=>{if(t("onAuthStateChange event:",e),t("session:",o),e==="SIGNED_IN"&&o){t("Signed in successfully!");try{localStorage.setItem("supabase.debug.lastSession",JSON.stringify({user:o.user?o.user.email:null,expires:o.expires_at?new Date(o.expires_at*1e3).toLocaleString():"N/A",event:e})),document.cookie=`sb-auth-token-forced=true; path=/; max-age=${60*60*24}; SameSite=Lax`}catch(n){console.error("Error saving debug session to localStorage",n)}setTimeout(()=>{window.location.assign("/dashboard?auth=callback_redirect&t="+new Date().getTime())},2e3)}else e==="TOKEN_REFRESHED"&&o?(t("Token refreshed successfully. Session active."),window.location.pathname==="/auth/callback"&&setTimeout(()=>{window.location.href="/dashboard"},1e3)):o===null&&e==="SIGNED_OUT"?(t(`${e} event detected`,void 0),u("La sesión ha finalizado. Por favor, inténtalo de nuevo.")):e==="INITIAL_SESSION"&&o===null&&(t("INITIAL_SESSION event with no session",void 0),window.location.pathname==="/auth/callback"&&setTimeout(async()=>{if(window.location.pathname==="/auth/callback"){const{data:n}=await d.auth.getSession();n.session||u("No se pudo iniciar sesión. Comprueba tus credenciales e inténtalo de nuevo.")}},5e3))});d.auth.getSession().then(async({data:e,error:o})=>{if(t("Initial getSession() in callback:",e),o){t("getSession error:",o),u(`Error al verificar sesión: ${o.message}`);return}if(e.session)t("Session already exists on callback load:",{user:e.session.user?e.session.user.email:null,expires:e.session.expires_at?new Date(e.session.expires_at*1e3).toLocaleString():"N/A"}),setTimeout(()=>{window.location.pathname==="/auth/callback"&&(window.location.href="/dashboard")},1e3);else{t("No session found on initial load");const n=new URLSearchParams(window.location.search),g=new URLSearchParams(window.location.hash.substring(1)),h=n.has("code"),s=g.has("access_token");h?t("URL contains code, Supabase SDK should be processing PKCE flow.",void 0):s?t("URL contains access_token, Supabase SDK should be processing Implicit flow/session.",void 0):(t("No code or token in URL - auth flow may not have started properly or failed before redirecting back.",void 0),setTimeout(async()=>{const{data:i}=await d.auth.getSession();window.location.pathname==="/auth/callback"&&!i.session&&u("No se detectó un código de autorización o token. La autenticación puede haber fallado.")},3e3))}});const a=document.getElementById("force-dashboard");a&&a.addEventListener("click",()=>{window.location.href="/dashboard"});const r=document.getElementById("check-storage");r&&r.addEventListener("click",async()=>{try{const e={};for(let s=0;s<localStorage.length;s++){const i=localStorage.key(s);i&&(e[i]=localStorage.getItem(i))}const o={};for(let s=0;s<sessionStorage.length;s++){const i=sessionStorage.key(s);i&&(o[i]=sessionStorage.getItem(i))}const{data:n}=await d.auth.getSession(),g=n&&n.session?`Activa (${n.session.user?n.session.user.email:"Sin email"})`:"No hay sesión",h=document.getElementById("debug-info");h&&(h.textContent=`
LOCAL STORAGE:
${JSON.stringify(e,null,2)}

SESSION STORAGE:
${JSON.stringify(o,null,2)}

SESIÓN SUPABASE:
${g}
                `)}catch(e){console.error("Error verificando almacenamiento:",e),t("Error verificando almacenamiento:",e)}});const c=document.getElementById("clear-storage");c&&c.addEventListener("click",()=>{localStorage.clear(),sessionStorage.clear(),alert("Almacenamiento limpiado. Recargando página..."),window.location.reload()})});
